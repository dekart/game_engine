<% builder.buttons do %>
  <%= link_to_function(button(:publish), mission_complete_stream_dialog(mission),
        :class => "publish button"
      ) %>
<% end %>

<% builder.message :complete do %>
  <%= t(".message") %> <%= mission.complete_text %>
<% end %>

<% if mission.child_missions.any? %>
  <div class="child_missions">
    <p><%= t(".child_missions") %></p>

    <% mission.child_missions.each do |child| %>
      <div class="child"><%= child.name %></div>
    <% end %>
  </div>
<% end %>

<% if Setting.b(:mission_completion_dialog) %>
  <% dialog :id => :mission_dialog do %>
    <h2><%= t(".dialog.title") %></h2>

    <div class="clearfix">
      <% if mission.image? %>
        <div class="image"><%= image_tag(mission.image.url(:small)) %></div>
      <% end %>

      <p><%= mission.complete_text %></p>
    </div>

    <p><%= t(".dialog.message") %></p>

    <div class="buttons">
      <%= link_to_function(button(:continue),
            mission_complete_stream_dialog(mission) + "$.dialog.close()",
            :class => "continue button"
          ) %>
    </div>
  <% end %>
<% end %>

<% if missions %>
  <% builder.on_ready do %>
    $('#mission_list').html('<%= escape_javascript(render("list", :missions => missions)) %>');
  <% end %>
<% end %>

<% if result.rank.just_completed? %>
  <% builder.on_ready do %>
    $(document).trigger('mission.complete');
  <% end %>
<% end %>