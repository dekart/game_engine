server {
  listen <%= public_ip %>:80;

  server_name <%= facebooker_config[:callback_domain] %>;

  root <%= current_path %>/public;

  rails_env <%= rails_env %>;

  <% if File.file?(File.expand_path("../config/deploy/certificates/#{ rails_env }.csr", __FILE__)) %>
    # SSL setup
    listen <%= public_ip %>:443 ssl;

    ssl_protocols SSLv3 TLSv1;
    ssl_certificate <%= current_path %>/config/deploy/certificates/<%= rails_env %>.csr;
    ssl_certificate_key <%= current_path %>/config/deploy/certificates/<%= rails_env %>.key;
    ssl_session_cache    shared:SSL:10m;
    ssl_session_timeout  20m;
  <% end %>

  access_log off;


  # GZIP compression
  
  gzip            on;
  gzip_min_length 500;
  gzip_comp_level 3;
  gzip_types      text/plain text/css text/javascript application/x-javascript application/json;


  # Ignored URLs
  location ~ null { return 404; }
  location ~ google-analytics\.com/ga\.js { return 404; }
  location ~ avg_ls_dom\.js { return 404; }

  location / {
    error_page 405 = /system/maintenance.html;
    
    try_files $uri /system/maintenance.html @passenger;
  }

  location @passenger {
    if ( $scheme = "https" ) {
      passenger_set_cgi_param HTTP_X_FORWARDED_PROTO https;
    }

    passenger_enabled on;
  }

  location ~* /(images|stylesheets|javascripts|fonts|system) {
    expires 1y;
    add_header Cache-Control public;

    try_files $uri =404;
  }

  location ~* ^.+\.(jpg|jpeg|gif|png|css|bmp|ico|swf)$ {
    expires 1y;
    add_header Cache-Control public;

    try_files $uri =404;
  }
}