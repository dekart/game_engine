<% result_for :fight do |builder| %>
  <% if !@fight.new_record? %>
    <% if @fight.winner == current_character %>
      <% builder.buttons do %>
        <%= link_to_function(button(:publish), fight_stream_dialog(@fight),
              :class => "publish button"
            ) %>

        <%= help_request_link(button(:request_help), @fight,
              :class => "request_help button"
            ) unless @fight.cause.is_a?(HelpRequest) %>
      <% end %>

      <%= builder.render "fights/create/success", :fight => @fight %>
    <% else %>
      <% unless @fight.cause.is_a?(HelpRequest) %>
        <% builder.buttons do %>
          <%= link_to_remote(button(:attack_again),
                :url    => @fight.cause ? respond_fight_path(@fight.cause) : fights_path(:victim_id => @fight.victim),
                :update => :result,
                :html   => {:class => "attack_again button"}
              ) %>

          <%= help_request_link(button(:request_help), @fight,
                :class => "request_help button"
              ) %>
        <% end %>
      <% end %>

      <%= builder.render "fights/create/failure", :fight => @fight %>
    <% end %>

    <%= builder.render "fights/create/details", :fight => @fight %>

    <% if @fight.cause %>
      <% builder.on_ready do %>
        $('#<%= dom_id(@fight.cause, :respond) %>').hide();
      <% end %>
    <% end %>
  <% elsif !@fight.enough_stamina? %>
    <%= builder.render("requirements/not_satisfied/stamina_point",
          :requirement => @fight.stamina_requirement
        ) %>
  <% elsif current_character.weak? %>
    <%= builder.render("requirements/not_satisfied/health_point",
          :requirement => @fight.health_requirement
        ) %>
  <% else %>
    <% builder.fail do %>
      <%= @fight.errors.on(:character) %>
    <% end %>
  <% end %>
<% end %>