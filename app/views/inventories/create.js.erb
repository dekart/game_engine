<%= render_to_result :shop do |builder| %>
  <% if @errors.empty? %>
    <% builder.buttons do %>
      <%= link_to_function(button(:publish), stream_dialog(:item_purchased, @item),
            :class => "publish button"
          ) if Setting.b(:stream_dialog_enabled) %>
      
      <% if @item.equippable? %> 
        <%= link_to(button(:equipment), equipment_inventories_path,
          :class => "equipment button"
        ) %>
        
      <% else %>
        <%= link_to(button(:inventory), inventories_url,
              :class => "inventory button"
            ) %>
       
      <% end %>      

      <%= link_to(inventory_use_button(@inventory), use_inventory_path(@inventory.item),
            :remote => true,
            :method => :post,
            :"data-click-once" => true,
            :class => "use button"
          ) if @inventory.usable? %>
    <% end %>

    <% builder.success do %>
      <%=  t(".messages.success",
            :amount     => @amount,
            :item_name  => strong_tag(@amount > 1 ? @item.plural_name : @item.name)
          ).html_safe %>
    <% end %>

    <% if @item.price? %>
      <table class="payouts">
        <tr>
          <td class="received">
            <h3><%= t(".you_received.title") %></h3>

            <%= payout(:item, item_image(@item, :medium), 
                  :label => (@amount ? @item.name + t(".amount", :amount => @amount) : @item.name)
                ) %>
          </td>
          <td class="spent">
            <h3><%= t(".you_spent.title") %></h3>

            <% if @item.basic_price > 0 %>
              <%= payout(:basic_money, number_to_currency(@purchase_amount * @item.basic_price)) %>
            <% end %>

            <% if @item.vip_price > 0 %>
              <%= payout(:vip_money, number_to_currency(@purchase_amount * @item.vip_price)) %>
            <% end %>
          </td>
        </tr>
      </table>
    <% end %>

    <% builder.on_ready do %>
      $('#inventory_fight_attributes').html('<%= escape_javascript(render("characters/fight_attributes")) %>');

      $(document).trigger('item.purchase', {item_id: <%= @item.id %>});
      
      <%= ga_track_event('Items', 'Purchased', "#{@item.name} (#{@item.availability})", @amount) %>
    <% end %>
  <% elsif !@item.requirements(@purchase_amount).satisfies?(current_character) %>
    <div class="unsatisfied_requirements">
      <%= unsatisfied_requirement_first(@item.requirements(@purchase_amount)) %>
    </div>
  <% else %>
    <% builder.fail do %>
      <% @errors.each do |code| %>
        <%= t(".errors.#{code}", :name => @item.name) %>
      <% end %>
    <% end %>
  <% end %>
<% end %>
