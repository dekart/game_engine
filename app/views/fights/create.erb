<div id="fight_result">
  <% if !@fight.new_record? %>
    <% if @fight.winner == current_character %>
      <div class="buttons">
        <%= link_to_feed_dialog(t(".buttons.publish"), Publisher::Fight, :attack,
              :template_data => {
                :victim           => fb_name(@fight.victim.user),
                :money            => number_to_currency(@fight.money),
                :experience       => @fight.experience,
                :attacker_hp_loss => @fight.attacker_hp_loss,
                :victim_hp_loss   => @fight.victim_hp_loss
              },
              :html => {:class => "publish button"}
            ) %>
        <%= help_request_link(fb_i(t(".buttons.request_help")), @fight,
              :class => "request_help button"
            ) %>
      </div>

      <p class="success">
        <% fb_i do %>
          <%= t(".messages.success", :pronoun => fb_pronoun(@fight.victim.user, :objective => true)) %>
          
          <%= fb_it(:user_name, character_name_link(@fight.victim)) %>
        <% end %>
      </p>

      <table class="payouts">
        <tr>
          <td class="received">
            <h3><%= fb_i(t(".you_received.title")) %></h3>

            <%= payout(:experience,
                  Character.human_attribute_name("experience"),
                  @fight.experience
                ) %>
            <%= payout(:basic_money,
                  Character.human_attribute_name("basic_money"),
                  number_to_currency(@fight.money)
                ) %>
          </td>
          <td class="lost">
            <h3><%= fb_i(t(".you_lost.title")) %></h3>

            <%= payout(:energy,
                  Character.human_attribute_name("energy"),
                  Configuration[:fight_energy_required]
                ) %>
            <%= payout(:health,
                  Character.human_attribute_name("health"),
                  @fight.attacker_hp_loss
                ) %>
          </td>
          <td class="victim_lost">
            <h3>
              <% fb_i do %>
                <%= t('.victim_lost.title') %>
                
                <%= fb_it(:user_name, character_name_link(@fight.victim)) %>
              <% end %>
            </h3>

            <%= payout(:health,
                  Character.human_attribute_name("health"),
                  @fight.victim_hp_loss
                ) %>
          </td>
        </tr>
      </table>

      <% content_for :script do %>
        <% unless @fight.cause %>
          Fight.hideVictim(<%= @victim.id %>);
        <% end %>
      <% end %>
    <% else %>
      <div class="buttons">
        <%= link_to_remote(fb_i(t(".buttons.attack_again")),
              :url    => @fight.cause ? respond_fight_url(@fight.cause, :canvas => false) : fights_url(:victim_id => @victim, :canvas => false),
              :update => :result,
              :html   => {:class => "attack_again button"}
            ) if current_character.energy > 0 %>
        <%= help_request_link(fb_i(t(".buttons.request_help")), @fight,
              :class => "request_help button"
            ) %>
      </div>

      <p class="fail">
        <% fb_i do %>
          <%= t(".messages.fail", :pronoun => fb_pronoun(@fight.victim.user, :objective => true)) %>

          <%= fb_it(:user_name, character_name_link(@fight.victim)) %>
        <% end %>
      </p>

      <table class="payouts">
        <tr>
          <td class="lost">
            <h3><%= fb_i(t(".you_lost.title")) %></h3>

            <%= payout(:energy,
                  Character.human_attribute_name("energy"),
                  Configuration[:fight_energy_required]
                ) %>
            <%= payout(:health,
                  Character.human_attribute_name("health"),
                  @fight.attacker_hp_loss
                ) %>
            <%= payout(:basic_money,
                  Character.human_attribute_name("basic_money"),
                  number_to_currency(@fight.money)
                ) %>
          </td>
          <td class="victim_lost">
            <h3>
              <% fb_i do %>
                <%= t(".victim_lost.title") %>
                
                <%= fb_it(:user_name, character_name_link(@fight.victim)) %>
              <% end %>
            </h3>

            <%= payout(:health,
                  Character.human_attribute_name("health"),
                  @fight.victim_hp_loss
                ) %>
          </td>
        </tr>
      </table>
    <% end %>

    <table class="details" cellspacing="0">
      <tr>
        <td class="attacker">
          <div class="character">
            <%= character_name_link(@fight.attacker, {:class => :name}, {:useyou => false}) %>
            <%= character_picture_link(@fight.attacker, :class => :picture) %>
            <div class="level">
              <%= fb_i(Character.human_attribute_name("level")) %> <%= @fight.attacker.level %>
            </div>
          </div>
          <div class="attributes">
            <div class="relations_attack"><%= @fight.attacker.inventory_attack_points %></div>
            <div class="relations"><%= @fight.attacker.relations.effective_size %></div>
            <div class="attack"><%= @fight.attacker.attack %></div>
          </div>
          <div class="best_items">
            <strong><%= fb_i(t(".details.best_offence")) %></strong>

            <% @fight.attacker.inventories.best_offence.each do |inventory| %>
              <%= item_image(inventory, :icon) %>
            <% end %>
          </div>
        </td>
        <td class="vs"><%= fb_i(t(".details.vs")) %></td>
        <td class="victim">
          <div class="character">
            <%= character_name_link(@fight.victim, {:class => :name}, {:useyou => false}) %>
            <%= character_picture_link(@fight.victim, :class => :picture) %>
            <div class="level">
              <%= fb_i(Character.human_attribute_name("level")) %> <%= @fight.victim.level %>
            </div>
          </div>
          <div class="attributes">
            <div class="relations_defence"><%= @fight.victim.inventory_defence_points %></div>
            <div class="relations"><%= @fight.victim.relations.effective_size %></div>
            <div class="defence"><%= t(".details.defence_unknown") %></div>
          </div>
          <div class="best_items">
            <strong><%= fb_i(t(".details.best_defence")) %></strong>

            <% @fight.victim.inventories.best_defence.each do |inventory| %>
              <%= item_image(inventory, :icon) %>
            <% end %>
          </div>
        </td>
      </tr>
    </table>

    <% content_tag(:div, :class => :item_details, :id => dom_id(@fight, :items)) do %>
      <%= link_to_remote(fb_i(t(".show_items")), 
            :url    => used_items_fight_url(@fight, :canvas => false),
            :update => dom_id(@fight, :items)
          ) %>
    <% end %>
  <% else %>
    <p><%= fb_i(@fight.errors.on(:character)) %></p>
  <% end %>
</div>

<%= character_level_up_block %>

<% content_for :script do %>
  <% if @fight.cause %>
    Fight.hideCauseRespond(<%= @fight.cause.id %>);
  <% end %>

  $('result').show();
<% end %>