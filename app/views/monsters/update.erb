<% result_for(:monster) do |builder| %>
  <% if @attack_result %>
    <% if @fight.monster.progress? %>
      <% builder.buttons do %>
        <%= link_to_remote(button(:attack),
              :url    => monster_path(@fight.monster),
              :method => :put,
              :update => :result,
              :with   => (@power_attack ? "'power_attack=1'" : nil),
              :html   => {
                :"data-click-once" => true,
                :class => "attack button"
              }
            ) %>
      <% end %>

      <% builder.success do %>
        <%= t(".message.progress", :monster => content_tag(:strong, @fight.monster.name)).html_safe %>
      <% end %>
      
      <% builder.on_ready do %>
        <%= ga_track_event('Monsters', 'Attack', @fight.monster.name, @fight.monster_damage) %>
      <% end %>
    <% elsif @fight.monster.won? %>
      <% dialog :id => :monster_dialog do %>
        <h2><%= t('.dialog.title', :monster => @fight.monster.name) %></h2>

        <div class="image"><%= monster_image(@fight.monster, :small) %></div>

        <p><%= t('.dialog.message', :monster => content_tag(:strong, @fight.monster.name)).html_safe %></p>

        <div class="buttons">
          <%= link_to_remote(button(:reward),
                :url    => reward_monster_path(@fight.monster),
                :before => '$.dialog.close()',
                :update => :result,
                :html   => {
                  :"data-click-once" => true,
                  :class => "reward button"
                }
              ) %>
        </div>
      <% end %>

      <% builder.success do %>
        <%= t(".message.won", :monster => content_tag(:strong, @fight.monster.name)).html_safe %>
      <% end %>

      <% builder.on_ready do %>
        <%= ga_track_event('Monsters', 'Won', @fight.monster.name) %>
      <% end %>
    <% end %>

    <table class="payouts">
      <tr>
        <td class="received">
          <h3><%= t(".you_received") %></h3>

          <%= payout(:experience, @fight.experience) %>

          <%= payout(:basic_money, number_to_currency(@fight.money)) %>
          
          <%= payout_list(@fight, @fight.payouts) %>
        </td>

        <td class="spent">
          <h3><%= t(".you_spent") %></h3>

          <%= payout(:hp, @fight.character_damage) %>

          <%= payout(:sp, @fight.stamina) %>
          
          <%= builder.render("payouts/result/item", :payout => @fight.boost) if @fight.boost %>
        </td>

        <td class="monster_spent">
          <h3><%= t(".monster_spent") %></h3>

          <%= payout(:hp, @fight.monster_damage) %>
        </td>
      </tr>
    </table>
  <% elsif @fight.monster.expired? %>
    <% builder.fail do %>
      <%= t(".message.expired", :monster => @fight.monster.name).html_safe %>
    <% end %>

    <% builder.on_ready do %>
      <%= ga_track_event('Monsters', 'Expired', @fight.monster.name) %>
    <% end %>
  <% elsif @fight.character.weak? %>
    <%= builder.render("requirements/not_satisfied/health_point",
          :requirement => current_character.weakness_requirement
        ) %>

    <% builder.on_ready do %>
      <%= ga_track_event('Monsters', 'Not Enough Health') %>
    <% end %>
  <% elsif @fight.character.sp < @fight.stamina_limit(@power_attack) %>
    <%= builder.render("requirements/not_satisfied/stamina_point",
          :requirement => @fight.stamina_requirement(@power_attack)
        ) %>

    <% builder.on_ready do %>
      <%= ga_track_event('Monsters', 'Not Enough Stamina') %>
    <% end %>
  <% elsif @fight.character.hp < @fight.hp_average_response_limit(@power_attack) %>
    <%= builder.render("requirements/not_satisfied/health_point",
          :requirement => @fight.hp_average_response_requirement(@power_attack)
        ) %>

    <% builder.on_ready do %>
      <%= ga_track_event('Monsters', 'Not Enough Health') %>
    <% end %>
  <% end %>

  <% builder.on_ready do %>
    $('#monster').html('<%= escape_javascript(render(@fight.monster.state, :monster => @fight.monster, :fight => @fight)) %>');
    $('#monster_boosts').replaceWith('<%= escape_javascript(render('boosts')) %>');
  <% end %>
<% end %>