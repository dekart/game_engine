<% result_for(:mission) do |builder| %>
  <% if @result.saved %>
    <% if @result.rank.just_completed? %>
      <%= builder.render("missions/fulfill/completed",
            :mission  => @mission,
            :result   => @result,
            :missions => @missions
          ) %>
    <% elsif @result.success %>
      <%= builder.render "missions/fulfill/success", :mission => @mission, :result => @result %>
    <% else %>
      <%= builder.render "missions/fulfill/failure", :mission => @mission, :result => @result %>
    <% end %>

    <%= builder.render "missions/fulfill/payouts", :mission => @mission, :result => @result %>

    <% if @result.group_rank.try(:just_created?) %>
      <%= builder.render "mission_groups/complete", :result => @result %>
    <% end %>
  <% elsif !@result.enough_energy? %>
    <%= builder.render("requirements/not_satisfied/energy_point",
          :requirement => @mission.energy_requirement
        ) %>
  <% elsif !@result.requirements_satisfied? %>
    <p><%= t(".requirements_not_satisfied.message") %></p>

    <div class="requirements clearfix">
      <%= unsatisfied_requirement_list(@mission.requirements) %>
    </div>

    <% builder.on_ready do %>
      Mission.requirementCallback = function(){
        <%= remote_function(
              :url    => fulfill_mission_path(@mission),
              :update => :result
            ) %>
      };

      $(document).bind('requirement.satisfy', Mission.onRequirementSatisfy);
    <% end %>
  <% elsif @result.rank.completed? %>
    <p><%= t(".already_completed.message") %></p>
  <% end %>

  <% if @mission_groups %>
    <% builder.on_ready do %>
      $('#mission_group_list').html('<%=
        escape_javascript(
          render("mission_groups/tabs",
            :groups   => @mission_groups,
            :current  => current_character.mission_groups.current
          )
        ) %>');
    <% end %>
  <% end %>
<% end %>