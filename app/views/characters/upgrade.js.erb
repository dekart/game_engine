<% dialog :upgrade_dialog do |d| %>
  <h2><%= t(".title") %></h2>

  <div id="upgrade_result"></div>

  <%= form_tag(upgrade_character_path(current_character), :remote => true) do %>
    <table id="upgrade_list" cellspacing="0" cellpadding="0" style="display:none">
      <tr class="points">
        <td class="name"><%= Character.human_attribute_name("points") %></td>
        <td class="value" id="upgrade_points"><%= current_character.points %></td>
        <td class="sliders" colspan="2">
          <%= t(".sliders") %>
        </td>
      </tr>

      <% Character::UPGRADABLE_ATTRIBUTES.each do |attribute| %>
        <tr class="<%= attribute %> attribute_item">
          <td class="name"><%= Character.human_attribute_name(attribute.to_s) %></td>
          <td class="value"><%= current_character.send(attribute) %></td>
          <td class="points"></td>
          <td class="controls">
          	<%= hidden_field_tag(attribute, 0, :class => :hidden_value) %>

            <div class="minus_value_attribute"></div>

            <div class="attribute_slider" data-count-points="<%= Setting.i("character_#{attribute}_upgrade_points")%>" data-character-upgrade="<%= Setting.i("character_#{attribute}_upgrade")%>"></div>

            <div class="plus_value_attribute"></div>
          </td>
        </tr>
      <% end %>
    </table>

    <div>
  	  <%= link_to_function(button("Upgrade", :disable_asset => true), 
  	        "$(this).parents('form').submit()",
            :class => "button upgrade"
          ) %>
    </div> 	
  <% end %>

  <div id="upgrade_finished" style="display:none;" class="note">
    <%= t(".finished.note") %>
  </div>

  <% d.on_ready do %>
    $(document).bind('character.upgrade_complete', function(){
      $('#upgrade_list').hide();
      $('#upgrade_finished').show();
    });

    $('#<%= current_character.points > 0 ? :upgrade_list : :upgrade_finished %>').show();

    $(document).trigger('character.upgrade_dialog');
    
    $.upgradeSliders(<%= current_character.points %>);
  <% end %>
<% end %>
