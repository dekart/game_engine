<fb:js-string var="dialog_content">
  <% form_for @assignment, :url => polymorphic_url([@assignment.context, @assignment], {:canvas => true}) do |f| %>
    <%= f.hidden_field :role %>
    <%= f.hidden_field :relation_id %>
    <script>
      function setAssignmentRelation(id){
        if($('new_assignment').selectedRelation){
          $('new_assignment').selectedRelation.removeClassName('selected');
        }

        $('relation_' + id).addClassName('selected');
        $('new_assignment').selectedRelation = $('relation_' + id);

        $('assignment_relation_id').setValue(id);
      }
    </script>

    <table>
      <tr>
        <% %w{not_assigned assigned}.each do |filter| %>
          <% if relations = current_character.relations.send(filter) and relations.any? %>
            <td>
              <h2><%= fb_i(t(".#{filter}.title")) %></h2>

              <table class="relations" cellspacing="0" cellpadding="0">
                <tr>
                  <th colspan="3"><%= fb_i(t(".columns.user")) %></th>
                  <th><%= fb_i(t("assignments.roles.#{@assignment.role}.description")) %></th>
                </tr>
                <% relations.each do |relation| %>
                  <% content_tag_for :tr, relation do %>
                    <td class="picture"><%= link_to_function(character_picture(relation.target_character), "setAssignmentRelation(#{relation.id})") %></td>
                    <td class="name"><%= link_to_function(character_name(relation.target_character), "setAssignmentRelation(#{relation.id})") %></td>
                    <td class="level"><%= Character.human_attribute_name("level") %> <%= relation.target_character.level %></td>
                    <td class="effect"><%= assignment_effect(@assignment, relation, :format => :short) %></td>
                  <% end %>
                <% end %>
              </table>
            </td>
          <% end %>
        <% end %>
      </tr>
    </table>
  <% end %>
</fb:js-string>

<fb:js-string var="dialog_title"><%= fb_i(t(".title")) %></fb:js-string>

<script>
  var dialog = new Dialog(Dialog.DIALOG_POP);
  dialog.onconfirm = function(){
    $('new_assignment').submit();
  };
  dialog.showChoice(dialog_title, dialog_content);
</script>