<%
  current_step = exract_current_step
%>

<% dom_ready do %>
  $(document).bind('tutorial.next_step', function() {
    <% if final_step?() %>
      <%= remote_function(
            :url => toggle_block_user_path(current_user, :block => 'tutorial'),
            :before => "$('#tutorial').hide()"
          ) %>
    <% else %>
      <%= remote_function(
            :url => user_path(current_user),
            :method => :put,
            :with => "'user[tutorial_step]=#{next_step(current_step)}'"
          ) %>
    <% end %>
  });
<% end %>

<div id="tutorial">
  <div id="tutorial_overlay"></div>
  <div id="tutorial_progress">
    <div id="skip_tutorial" class="block">
      <%= hide_block_link('tutorial', t("tutorial.skip")) %>
    </div>
    <h3><%= t("tutorial.progress") %></h3>
    <div>
      <%= step_index.next %> / <%= Tutorial::STEPS.size %>
    </div>
    <%= percentage_bar(step_index.next.to_f / Tutorial::STEPS.size.to_f * 100) %>
    
    <div id="current_step">
      <%= t("tutorial.steps.current") %>
      <%= step_title(current_step) %>
    </div>
    
    <div>
      <%= t("tutorial.steps.next") %>
      <% if Tutorial::STEPS.size == step_index.next %>
        <%= t("tutorial.steps.finish") %>
      <% else %>
        <%= step_title(Tutorial::STEPS[step_index.next]) %>
      <% end %>
    </div>
  </div>
  
  <div id="current_step">
    <% case current_step %>
      <% when :hello_new_user %>
        <% dom_ready do %>
          $("a.missions").qtip({
            content: 'This is missions',
            show: { ready: true },
            hide: false
          });
          <%= target_trigger("a.missions") %>
        <% end %>
      <% when :choose_character %>
        <% dom_ready do %>
          $("a.missions").qtip({
            content: 'This is missions',
            show: { ready: true },
            hide: false
          });
          <%= target_trigger("a.missions") %>
        <% end %>
    <% end %>
  </div>
</div>

  