<%= title(t(".title")) %>

<%= render "relations/buttons", :current => :gifts %>

<div class="note"><%= t(".note") %></div>

<div id="gift_form" class="clearfix">
  <h3>
    <%= raw t(".gift.title",
          :change => link_to(t(".gift.change"), edit_gift_path(@gift))
        ) %>
  </h3>

  <div class="gift clearfix">
    <div class="item">
      <%= item_image(@gift.item, :small) %>

      <div class="name"><%= @gift.item.name %></div>

      <div class="payouts">
        <%= render "items/effects", :item => @gift.item %>
      </div>
    </div>
  </div>

  <div class="friend_groups" style="display:none;">
    <% form_tag gift_url(@gift), :id => :group_switcher, :method => :put do %>
      <%= hidden_field_tag :group  %>
      <%= hidden_field_tag :friend_ids %>
    
      <% %w{all players non_players}.each do |type| %>
        <%= link_to_function(t(".groups.#{type}", :app => t("app_name")), "$('#group').val('#{type}'); $('#group_switcher').submit()",
              :id     => "group_#{type}",
              :class  => "friend_group #{:current if @group == type.to_sym}"
            ) %>
      <% end %>
    <% end %>
  </div>

  <div class="invitation_form">
    <% content_for :gift_message do %>
      <%= raw t(".request.message",
            :user => fb_name(current_user, :linked => :false),
            :app  => t("app_name"),
            :item => @gift.item.name
          ) %>

      <%= fb_req_choice(
            t(".request.accept", :item => @gift.item.name),
            gift_url(@gift, :reference => :gift, :canvas => true)
          ) %>
      <%= fb_req_choice(
            t(".request.accept_all"), gift_url('all', :reference => :gift, :canvas => true)
          ) %>
    <% end %>

    <% fb_serverfbml do %>
      <%= stylesheet_link_tag(skin_path) %>
    
      <div id="invitation_form_fbml">
        <% fb_request_form(t(".request.title"), :gift_message, confirm_gift_url(@gift)) do %>
          <div class="selector">
            <%= fb_multi_friend_selector(t(".request.note"),
                  :exclude_ids => @exclude_ids.join(","),
                  :cols => 3,
                  :rows => 3
                ) %>
          </div>
        <% end %>
    <% end %>
  </div>
</div>

<% dom_ready do %>
  $(document).bind('facebook.ready', function(){
    FB.Facebook.apiClient.friends_get(null, function(result) {
      if(result){
        $('#friend_ids').val(result.join(','));
        $('.friend_groups').show();
      }
    })
  });
<% end %>
