<% dialog do |d| %>
  <%= form_for([@assignment.context, @assignment], :remote => true) do |f| %>
    <h2><%= t(".title") %></h2>

    <%= f.hidden_field :role %>
    <%= f.hidden_field :relation_id %>

    <% filters = %w{not_assigned assigned} %>

    <% tabs :id => :assignment_tabs do |t| %>
      <% filters.each do |filter| %>
        <% t.tab filter, t(".#{filter}.title") do %>
          <% if relations = @relations.send(filter) and relations.any? %>
            <table class="relations" cellspacing="0" cellpadding="0">
              <tr>
                <th colspan="3"><%= t(".columns.user") %></th>
                <th><%= t("assignments.roles.#{@assignment.role}.description") %></th>
              </tr>

              <% relations.each do |relation| %>
                <tr class="relation" data-value="<%= relation.id %>">
                  <% if relation.is_a?(FriendRelation) %>
                    <td class="picture"><%= character_picture(relation.character) %></td>
                    <td class="name"><%= character_name(relation.character) %></td>
                  <% else %>
                    <td class="picture"><%= image_tag('mercenary.gif', :alt => relation.name) %></td>
                    <td class="name"><%= relation.name %></td>
                  <% end %>

                  <td class="level">
                    <%= Character.human_attribute_name("level") %>
                    <%= relation.level %>
                  </td>
                  <td class="effect"><%= assignment_effect(@assignment, relation, :format => :short) %></td>
                </tr>
              <% end %>
            </table>
          <% else %>
            <div class="empty_set"><%= t(".#{filter}.empty_set") %></div>
          <% end %>
        <% end %>
      <% end %>
    <% end %>

    <%= link_to_function(button(:promote), "$(this).parents('form').submit()",
          :onclick  => '$.dialog.close()',
          :'data-click-once' => true,
          :class => 'promote button'
        ) %>
  <% end %>

  <% d.on_ready do %>
    AssignmentForm.setup();

    $(document).trigger('remote_content.received');
  <% end %>
<% end %>
