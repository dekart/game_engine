<%= render_to_result :item_collection do |builder| %>
  <% if @result.applied? %>
    <% builder.buttons do %>
      <%= link_to_function(button(:publish), stream_dialog(:collection_completed, @collection),
            :class => "publish button"
          ) if Setting.b(:stream_dialog_enabled) %>
    <% end %>

    <% builder.success do %>
      <%= t(".messages.success") %>
    <% end %>

    <table class="payouts">
      <tr>
        <td class="received">
          <h3><%= t(".you_received") %></h3>

          <%= payout_list(@collection, @result.payouts) %>
        </td>
        <td class="spent">
          <h3><%= t(".you_spent") %></h3>

          <%= payout_list(@collection, @result.payouts, :action => :remove) %>
        </td>
      </tr>
    </table>
  <% else %>
    <p class="fail"><%= @result.errors.on(:character) %></p>
  <% end %>
<% end %>

<% if @result.applied? %>
  $('#<%= dom_id(@collection) %>').replaceWith('<%= escape_javascript(render('item_collection', :collection => @collection)) %>');
 
    CollectionList.blurItems(
      $('<%= @collection.missing_items(current_character).collect{|i| ".#{dom_id(i)}" }.join(",") %>')
  );
<% end %>

$(document).trigger('result.received');
